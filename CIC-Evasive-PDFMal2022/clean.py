import time
import pandas as pd
import numpy as np
from src.config import BASE_DIR

def clean():
    df = pd.read_csv(BASE_DIR / 'CIC-Evasive-PDFMal2022/data/PDFMalware2022.csv')
    del df["Fine name"]
    # print(df.columns)
    
    df.replace({'-1': np.NaN}, inplace=True)
    df = df.dropna(how='all',axis=0)
    print(df[df.isnull().all(axis=1)])

    df.replace({'(most': np.NaN},  inplace=True)
    df.replace({"_Pro_Rodeo_Pix_": np.NaN},  inplace=True)
    df.replace({"_Pro_Rodeo_Pix_'": np.NaN},  inplace=True)
    df.replace({"pdfid.py": np.NaN},  inplace=True)
    df.replace({"pdfHeader)": np.NaN},  inplace=True)
    df.replace({"bytes[endHeader]": np.NaN},  inplace=True)
    df.replace({"list": np.NaN},  inplace=True)
    df.replace({">": np.NaN},  inplace=True)
    df['text'] = df['text'].str.replace('No', '0')
    df['text'] = df['text'].str.replace('unclear', '1')
    df['text'] = df['text'].str.replace('Yes', '2')
    df['header'] = df['header'].replace('^(?!.*\\t%PDF-1\.[0-7]$).*', '0', regex=True)
    df['header'] = df['header'].replace('^\\t%PDF-1\.[0-7]$', '1', regex=True)
    df['Class'] = df['Class'].str.replace('Benign', '0')
    df['Class'] = df['Class'].str.replace('Malicious', '1')
    # print(df.dtypes)
    for column in df.columns:
        if df[column].dtype == 'object':
            df[column] = df[column].str.replace('(1)', '')
            df[column] = df[column].str.replace('(2)', '')
    
        print(f"{column} {df[column].isnull().sum()}")
    
    df.fillna(df.dtypes.replace({'int64':0, 'float64': 0.0, 'O': '0'}), inplace=True)
    
    df[['pdfsize', 'metadata size', 'pages', 'xref Length', 'title characters',
       'isEncrypted', 'embedded files', 'images', 'text', 'header', 'obj',
       'endobj', 'stream', 'endstream', 'xref', 'trailer', 'startxref',
       'pageno', 'encrypt', 'ObjStm', 'JS', 'Javascript', 'AA', 'OpenAction',
       'Acroform', 'JBIG2Decode', 'RichMedia', 'launch', 'EmbeddedFile', 'XFA',
       'Colors', 'Class']] = df[['pdfsize', 'metadata size', 'pages', 'xref Length', 'title characters',
       'isEncrypted', 'embedded files', 'images', 'text', 'header', 'obj',
       'endobj', 'stream', 'endstream', 'xref', 'trailer', 'startxref',
       'pageno', 'encrypt', 'ObjStm', 'JS', 'Javascript', 'AA', 'OpenAction',
       'Acroform', 'JBIG2Decode', 'RichMedia', 'launch', 'EmbeddedFile', 'XFA',
       'Colors', 'Class']].astype('int64')

    
    for column in df.columns:
        print(f"{column} {df[column].isnull().sum()}")
    
    print(df.dtypes)

    df.to_csv(BASE_DIR / 'CIC-Evasive-PDFMal2022/data/PDFMalware2022_cleaned.csv', index=False)

    # df = pd.read_csv(BASE_DIR / 'CIC-Evasive-PDFMal2022/data/PDFMalware2022_cleaned.csv')
    print(df['text'].value_counts())
    print(df['header'].value_counts())
    print(df['Class'].value_counts())

if __name__=="__main__":
    start = time.time()
    clean()
    print(f"time elapsed: {time.time()-start}s")